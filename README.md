# Flutter åŠ¨æ€ SO åŠ è½½è§£å†³æ–¹æ¡ˆ

## ğŸ“– é¡¹ç›®ç®€ä»‹

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Flutter åŠ¨æ€ SO åŠ è½½è§£å†³æ–¹æ¡ˆï¼Œå®ç°äº†ä»æ„å»ºåˆ°è¿è¡Œçš„å…¨è‡ªåŠ¨åŒ–æµç¨‹ï¼š

- **æ„å»ºæ—¶è‡ªåŠ¨åŒ–**ï¼šä» APK æ„å»ºäº§ç‰©ä¸­è‡ªåŠ¨æå–çœŸå®çš„ Flutter SO æ–‡ä»¶
- **æ™ºèƒ½ä¸Šä¼ **ï¼šè‡ªåŠ¨ä¸Šä¼  SO åŒ…åˆ°æœ¬åœ°æœåŠ¡å™¨ï¼Œæ”¯æŒç‰ˆæœ¬ç®¡ç†å’Œé‡å¤æ£€æµ‹
- **è¿è¡Œæ—¶åŠ¨æ€åŠ è½½**ï¼šä»æœåŠ¡å™¨åŠ¨æ€ä¸‹è½½å¹¶åŠ è½½ SO æ–‡ä»¶
- **APK ç˜¦èº«**ï¼šç§»é™¤ SO æ–‡ä»¶å APK ä½“ç§¯å‡å°‘çº¦ 70%
- **å¤šæ¶æ„æ”¯æŒ**ï¼šå®Œæ•´æ”¯æŒ arm64-v8a å’Œ armeabi-v7a æ¶æ„

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

```
dynamicLoadFLutterSo/
â”œâ”€â”€ README.md                           # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ app/                                # Android ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ build.gradle                    # åº”ç”¨æ„å»ºé…ç½®
â”‚   â”œâ”€â”€ src/main/assets/
â”‚   â”‚   â”œâ”€â”€ flutterso.json             # Flutter å¼•æ“ SO é…ç½®
â”‚   â”‚   â””â”€â”€ appso.json                 # Flutter åº”ç”¨ SO é…ç½®
â”‚   â””â”€â”€ src/main/java/.../
â”‚       â”œâ”€â”€ FlutterManager.kt          # SO åŠ è½½ç®¡ç†å™¨
â”‚       â”œâ”€â”€ SoPackageManager.kt        # SO åŒ…ç®¡ç†å™¨
â”‚       â”œâ”€â”€ DynamicFlutterActivity.kt  # Flutter ç•Œé¢
â”‚       â””â”€â”€ DynamicSoTestActivity.kt   # æµ‹è¯•å·¥å…·ç•Œé¢
â”œâ”€â”€ dart_server/                        # SO åŒ…åˆ†å‘æœåŠ¡å™¨
â”‚   â”œâ”€â”€ server.sh                      # æœåŠ¡å™¨ç®¡ç†è„šæœ¬
â”‚   â”œâ”€â”€ bin/server.dart                # HTTP æœåŠ¡å™¨ä¸»ç¨‹åº
â”‚   â””â”€â”€ so_packages/                   # SO åŒ…å­˜å‚¨ç›®å½•
â”œâ”€â”€ flutter_module/                     # Flutter æ¨¡å—
â”‚   â””â”€â”€ lib/main.dart                  # Flutter åº”ç”¨ä»£ç 
â””â”€â”€ buildSrc/                          # Gradle æ„å»ºæ’ä»¶
    â””â”€â”€ src/main/java/.../
        â”œâ”€â”€ FlutterDynamicPlugin.java  # ä¸»æ’ä»¶ç±»
        â””â”€â”€ SoDynamicTask.java         # SO å¤„ç†ä»»åŠ¡
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨ SO åˆ†å‘æœåŠ¡å™¨

```bash
# è¿›å…¥æœåŠ¡å™¨ç›®å½•å¹¶å¯åŠ¨
cd dart_server
./server.sh
```

æœåŠ¡å™¨å¯åŠ¨åä¼šï¼š
- è‡ªåŠ¨æ€æ‰å ç”¨ 1234 ç«¯å£çš„è¿›ç¨‹
- è®¾ç½® ADB åå‘ç«¯å£æ˜ å°„
- å¯åŠ¨ HTTP æœåŠ¡å™¨ç›‘å¬ 1234 ç«¯å£

### 2. æ„å»ºé¡¹ç›®

```bash
# æ„å»º Release APKï¼ˆè‡ªåŠ¨å¤„ç† SO æ–‡ä»¶ï¼‰
./gradlew assembleRelease
```

æ„å»ºè¿‡ç¨‹ä¼šè‡ªåŠ¨ï¼š
1. ä»æ„å»ºäº§ç‰©ä¸­æå– `libflutter.so` å’Œ `libapp.so`
2. ä¸ºæ¯ä¸ªæ¶æ„åˆ›å»ºç‹¬ç«‹çš„ ZIP åŒ…
3. ä¸Šä¼  ZIP åŒ…åˆ°æœ¬åœ°æœåŠ¡å™¨
4. æ›´æ–° assets é…ç½®æ–‡ä»¶
5. ä» APK ä¸­ç§»é™¤åŸå§‹ SO æ–‡ä»¶

### 3. å®‰è£…å’Œæµ‹è¯•

```bash
# å®‰è£… APK
adb install -r app/build/outputs/apk/release/app-release.apk

# å¯åŠ¨åº”ç”¨
adb shell am start -n com.example.flutterdynamic/.MainActivity
```

## ğŸ“± ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•ä¸€ï¼šåº”ç”¨ç•Œé¢æ“ä½œ
1. **æ‰“å¼€åº”ç”¨** - ç‚¹å‡»æ¡Œé¢å›¾æ ‡å¯åŠ¨
2. **ç‚¹å‡»"å¯åŠ¨Flutter"** - ä½“éªŒåŠ¨æ€ SO åŠ è½½å’Œ Flutter ç•Œé¢
3. **ç‚¹å‡»"åŠ¨æ€SOæµ‹è¯•å·¥å…·"** - è¿è¡Œå®Œæ•´åŠŸèƒ½æµ‹è¯•å’Œæ—¥å¿—æŸ¥çœ‹

### æ–¹æ³•äºŒï¼šå‘½ä»¤è¡Œæµ‹è¯•
```bash
# å¯åŠ¨æµ‹è¯•ç•Œé¢
adb shell am start -n com.example.flutterdynamic/.DynamicSoTestActivity

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
adb logcat | grep -E "(FlutterManager|DynamicSo)"
```

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯ç‰¹ç‚¹

### æ„å»ºæ—¶è‡ªåŠ¨åŒ–
- **çœŸå® SO æå–**ï¼šä» APK æ„å»ºäº§ç‰©æå–ï¼Œéæ¨¡æ‹Ÿæ–‡ä»¶
- **æ™ºèƒ½ç‰ˆæœ¬ç®¡ç†**ï¼šè‡ªåŠ¨è¯†åˆ« Flutter SDK ç‰ˆæœ¬å’Œåº”ç”¨ç‰ˆæœ¬
- **é‡å¤æ£€æµ‹**ï¼šé¿å…é‡å¤ä¸Šä¼ ç›¸åŒç‰ˆæœ¬çš„ SO åŒ…
- **å¤šæ¶æ„å¤„ç†**ï¼šä¸ºæ¯ä¸ªæ¶æ„åˆ›å»ºç‹¬ç«‹çš„ ZIP åŒ…

### è¿è¡Œæ—¶åŠ¨æ€åŠ è½½
- **ç½‘ç»œé€šä¿¡**ï¼šé€šè¿‡ ADB åå‘ç«¯å£æ˜ å°„è®¿é—®æœ¬åœ°æœåŠ¡å™¨
- **å®Œæ•´æ€§æ ¡éªŒ**ï¼šMD5 å’Œæ–‡ä»¶å¤§å°åŒé‡éªŒè¯
- **æ¶æ„é€‚é…**ï¼šè‡ªåŠ¨é€‰æ‹©åŒ¹é…è®¾å¤‡æ¶æ„çš„ SO æ–‡ä»¶
- **ç‰ˆæœ¬å…¼å®¹æ€§**ï¼šæ£€æŸ¥ SO ç‰ˆæœ¬ä¸åº”ç”¨ç‰ˆæœ¬çš„å…¼å®¹æ€§

### æœåŠ¡å™¨åŠŸèƒ½
- **HTTP API**ï¼šæä¾› RESTful æ¥å£
- **æ–‡ä»¶ç®¡ç†**ï¼šè‡ªåŠ¨ç®¡ç† SO åŒ…å­˜å‚¨å’Œç‰ˆæœ¬
- **Web ç•Œé¢**ï¼šæµè§ˆå™¨è®¿é—®æŸ¥çœ‹ SO åŒ…ä¿¡æ¯
- **ä¸Šä¼ æ”¯æŒ**ï¼šæ”¯æŒæ„å»ºæ—¶è‡ªåŠ¨ä¸Šä¼ 

## ğŸ“Š æ€§èƒ½æ•°æ®

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| APK ä½“ç§¯å‡å°‘ | ~70% | ç§»é™¤ SO æ–‡ä»¶åçš„ä½“ç§¯å‡å°‘ |
| Flutter å¼•æ“ SO | ~9MB | libflutter.so å‹ç¼©åŒ…å¤§å° |
| Flutter åº”ç”¨ SO | ~2.5MB | libapp.so å‹ç¼©åŒ…å¤§å° |
| é¦–æ¬¡ä¸‹è½½æ—¶é—´ | 10-15ç§’ | å–å†³äºç½‘ç»œç¯å¢ƒ |
| æ”¯æŒæ¶æ„ | 2ç§ | arm64-v8a, armeabi-v7a |
| è‡ªåŠ¨åŒ–ç¨‹åº¦ | 100% | æ— éœ€æ‰‹åŠ¨è„šæœ¬æ“ä½œ |

## ğŸ› ï¸ é…ç½®è¯´æ˜

### Gradle æ’ä»¶é…ç½®

åœ¨ `app/build.gradle` ä¸­é…ç½®åŠ¨æ€ SOï¼š

```gradle
plugins {
    id 'com.example.flutterplugin'
}

dynamicSo {
    // é…ç½® libapp.so
    libapp {
        minVersion '1.0.0'
        maxVersion '6.8.8'
    }

    // é…ç½® libflutter.so
    libflutter {
        minVersion '1.0.0'
        maxVersion '9.8.8'
    }
}
```

### SO é…ç½®æ–‡ä»¶

æ„å»ºåè‡ªåŠ¨ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ç¤ºä¾‹ï¼š

**flutterso.json**ï¼š
```json
{
  "armeabi-v7a": {
    "size": 7424684,
    "url": "http://127.0.0.1:1234/api/download/libflutter_1.0.0-xxx-armeabi-v7a.zip",
    "md5": "6a71f85cb8731717f2a069a2ee384a1e"
  },
  "arm64-v8a": {
    "size": 10554968,
    "url": "http://127.0.0.1:1234/api/download/libflutter_1.0.0-xxx-arm64-v8a.zip",
    "md5": "6507e161d6cf099baba4650abea05983"
  },
  "minAppVersion": "1.0.0",
  "libflutterVersion": "1.0.0",
  "maxAppVersion": "9.8.8"
}
```

## ğŸ”„ å·¥ä½œæµç¨‹è¯¦è§£

### æ„å»ºæ—¶æµç¨‹
1. **Gradle æ’ä»¶æ¿€æ´»** â†’ æ£€æµ‹åˆ° Android åº”ç”¨æ’ä»¶
2. **SO æ–‡ä»¶å‘ç°** â†’ ä» `merge{Variant}NativeLibs` ä»»åŠ¡è¾“å‡ºä¸­æŸ¥æ‰¾
3. **ç‰ˆæœ¬è¯†åˆ«** â†’ è‡ªåŠ¨è¯†åˆ« Flutter SDK ç‰ˆæœ¬å’Œåº”ç”¨ç‰ˆæœ¬
4. **æ–‡ä»¶å¤„ç†** â†’ ä¸ºæ¯ä¸ªæ¶æ„åˆ›å»ºç‹¬ç«‹çš„ ZIP åŒ…
5. **æœåŠ¡å™¨ä¸Šä¼ ** â†’ ä¸Šä¼ åˆ°æœ¬åœ° Dart æœåŠ¡å™¨
6. **é…ç½®æ›´æ–°** â†’ æ›´æ–° assets ä¸­çš„ JSON é…ç½®æ–‡ä»¶
7. **æ–‡ä»¶æ¸…ç†** â†’ ä» APK ä¸­åˆ é™¤åŸå§‹ SO æ–‡ä»¶

### è¿è¡Œæ—¶æµç¨‹
1. **åº”ç”¨å¯åŠ¨** â†’ FlutterManager åˆå§‹åŒ–
2. **æ¶æ„æ£€æµ‹** â†’ è·å–è®¾å¤‡æ”¯æŒçš„ ABI
3. **æœåŠ¡å™¨è¯·æ±‚** â†’ é€šè¿‡ 127.0.0.1:1234 è·å– SO åŒ…åˆ—è¡¨
4. **ç‰ˆæœ¬åŒ¹é…** â†’ é€‰æ‹©å…¼å®¹çš„ SO åŒ…ç‰ˆæœ¬
5. **æ–‡ä»¶ä¸‹è½½** â†’ ä¸‹è½½å¯¹åº”æ¶æ„çš„ ZIP åŒ…
6. **å®Œæ•´æ€§éªŒè¯** â†’ MD5 å’Œæ–‡ä»¶å¤§å°æ ¡éªŒ
7. **è§£å‹åŠ è½½** â†’ æå– SO æ–‡ä»¶å¹¶åŠ¨æ€åŠ è½½
8. **Flutter åˆå§‹åŒ–** â†’ å¯åŠ¨ Flutter å¼•æ“

## ğŸ” è°ƒè¯•å’Œæ—¥å¿—

### æŸ¥çœ‹åº”ç”¨æ—¥å¿—
```bash
# æŸ¥çœ‹ Flutter ç®¡ç†å™¨æ—¥å¿—
adb logcat | grep FlutterManager

# æŸ¥çœ‹åŠ¨æ€ SO ç›¸å…³æ—¥å¿—
adb logcat | grep -E "(DynamicSo|SoPackage)"
```

### æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
```bash
cd dart_server
cat server.log
```

### æµ‹è¯•ç½‘ç»œè¿æ¥
```bash
# æµ‹è¯•æœåŠ¡å™¨çŠ¶æ€
adb shell curl -s http://127.0.0.1:1234/api/status

# æŸ¥çœ‹ SO åŒ…åˆ—è¡¨
adb shell curl -s http://127.0.0.1:1234/api/so-packages
```

### æ„å»ºæ—¥å¿—åˆ†æ
```bash
# æŸ¥çœ‹æ„å»ºè¿‡ç¨‹ä¸­çš„ SO å¤„ç†ä¿¡æ¯
./gradlew assembleRelease --info | grep -E "(flutterSo|appSo|SoDynamic)"
```

## ğŸŒ æœåŠ¡å™¨ API

### è·å– SO åŒ…åˆ—è¡¨
```
GET /api/so-packages
```

### ä¸‹è½½ SO åŒ…
```
GET /api/download/<filename>
```

### ä¸Šä¼  SO åŒ…
```
POST /api/upload
Content-Type: multipart/form-data
```

### æœåŠ¡å™¨çŠ¶æ€
```
GET /api/status
```

### Web ç•Œé¢
```
GET /
```

## ğŸ› ï¸ å¼€å‘å’Œæ‰©å±•

### æ·»åŠ æ–°çš„æ¶æ„æ”¯æŒ
1. åœ¨ `app/build.gradle` ä¸­æ·»åŠ æ–°çš„ ABI è¿‡æ»¤å™¨
2. æ›´æ–° `FlutterManager.kt` ä¸­çš„æ¶æ„æ£€æµ‹é€»è¾‘
3. ä¿®æ”¹ `SoDynamicTask.java` ä¸­çš„æ¶æ„æ•°ç»„

### è‡ªå®šä¹‰æœåŠ¡å™¨åœ°å€
ä¿®æ”¹ `FlutterManager.kt` ä¸­çš„æœåŠ¡å™¨ URLï¼š
```kotlin
private val localServerUrl = "http://your-server:port"
```

### æ‰©å±•é…ç½®é€‰é¡¹
åœ¨ `DynamicSoExtension.java` ä¸­æ·»åŠ æ–°çš„é…ç½®é¡¹ã€‚

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æœåŠ¡å™¨ä¾èµ–**ï¼šæ„å»ºå‰å¿…é¡»å…ˆå¯åŠ¨æœ¬åœ°æœåŠ¡å™¨
2. **ç½‘ç»œç¯å¢ƒ**ï¼šç¡®ä¿ ADB åå‘ç«¯å£æ˜ å°„æ­£å¸¸å·¥ä½œ
3. **æ¶æ„å…¼å®¹**ï¼šç›®å‰ä»…æ”¯æŒ ARM æ¶æ„ï¼ˆarm64-v8a, armeabi-v7aï¼‰
4. **ç‰ˆæœ¬ç®¡ç†**ï¼šSO ç‰ˆæœ¬ä¸åº”ç”¨ç‰ˆæœ¬éœ€è¦ä¿æŒå…¼å®¹æ€§
5. **å­˜å‚¨ç©ºé—´**ï¼šé¦–æ¬¡è¿è¡Œéœ€è¦ä¸‹è½½ SO æ–‡ä»¶ï¼Œç¡®ä¿è®¾å¤‡æœ‰è¶³å¤Ÿç©ºé—´

## ğŸ” ç­¾åä¿¡æ¯

- **Keystore æ–‡ä»¶**ï¼š`app/flutter-dynamic.keystore`
- **Store å¯†ç **ï¼š`123456`
- **Key åˆ«å**ï¼š`flutter-dynamic`
- **Key å¯†ç **ï¼š`123456`

## ğŸ¯ å®ŒæˆçŠ¶æ€

- âœ… **æ„å»ºæ—¶è‡ªåŠ¨åŒ–**ï¼šå®Œå…¨è‡ªåŠ¨æå–å’Œä¸Šä¼  SO æ–‡ä»¶
- âœ… **è¿è¡Œæ—¶åŠ¨æ€åŠ è½½**ï¼šæ”¯æŒå¤šæ¶æ„åŠ¨æ€åŠ è½½
- âœ… **ç½‘ç»œé€šä¿¡**ï¼šADB åå‘ç«¯å£æ˜ å°„é€šä¿¡
- âœ… **å®Œæ•´æ€§æ ¡éªŒ**ï¼šMD5 å’Œæ–‡ä»¶å¤§å°éªŒè¯
- âœ… **ç‰ˆæœ¬ç®¡ç†**ï¼šè‡ªåŠ¨ç‰ˆæœ¬è¯†åˆ«å’Œå…¼å®¹æ€§æ£€æŸ¥
- âœ… **APK ç˜¦èº«**ï¼šè‡ªåŠ¨ç§»é™¤ SO æ–‡ä»¶å‡å°‘ä½“ç§¯
- âœ… **æœåŠ¡å™¨ç®¡ç†**ï¼šå®Œæ•´çš„ HTTP æœåŠ¡å™¨å’Œ Web ç•Œé¢
- âœ… **æµ‹è¯•å·¥å…·**ï¼šå†…ç½®æµ‹è¯•ç•Œé¢å’Œæ—¥å¿—æŸ¥çœ‹

---

**è¿™æ˜¯ä¸€ä¸ªç”Ÿäº§çº§çš„ Flutter åŠ¨æ€ SO åŠ è½½è§£å†³æ–¹æ¡ˆï¼Œæä¾›äº†ä»æ„å»ºåˆ°è¿è¡Œçš„å®Œæ•´è‡ªåŠ¨åŒ–æµç¨‹ï¼Œå¯ç›´æ¥åº”ç”¨äºå®é™…é¡¹ç›®å¼€å‘ï¼** ğŸ‰

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸å¯åŠ¨ï¼ˆ`./server.sh`ï¼‰
2. ADB è¿æ¥æ˜¯å¦æ­£å¸¸ï¼ˆ`adb devices`ï¼‰
3. ç«¯å£æ˜ å°„æ˜¯å¦ç”Ÿæ•ˆï¼ˆ`adb reverse --list`ï¼‰
4. æ„å»ºæ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
5. åº”ç”¨è¿è¡Œæ—¶çš„ logcat è¾“å‡º